<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Pita My Shawarma | Food Truck Locations</title>
    <meta name="description"
        content="Find the Pita My Shawarma food truck! Check our schedule for upcoming events, festivals, and pop-ups around Pittsburgh.">
    <meta name="keywords" content="events, food truck, schedule, pittsburgh, festivals, street food, shawarma truck">

    <link rel="stylesheet" href="css/output.css">
    <link rel="stylesheet" href="css/styles.css"> <!-- Ensure global styles are loaded -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
            overflow: hidden;
            /* Prevent scrolling of the whole page */
        }

        h1,
        h2,
        h3,
        .font-display {
            font-family: 'Playfair Display', serif;
        }

        .brand-teal {
            color: #02a69b;
        }

        .bg-brand-teal {
            background-color: #02a69b;
        }

        .hover\:bg-brand-teal-dark:hover {
            background-color: #01746c;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
            background-color: #f0f0f0;
        }

        /* Event Card Styles */
        .event-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .event-card.active,
        .event-card:hover {
            background-color: white;
            transform: translateX(5px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
            border-left-color: #02a69b;
        }

        /* Leaflet Popups */
        .leaflet-popup-content p {
            margin: 5px 0 !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Loader */
        .loader {
            border: 5px solid #e2e8f0;
            border-top: 5px solid #02a69b;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Glow Animation (re-using global if available, but keeping here for safety) */
        @keyframes pulse-glow {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 5px #ffffff, 0 0 10px #ffffff;
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 25px #c7f9cc;
            }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2.5s infinite ease-in-out;
        }

        /* Custom Marker Icon */
        .map-marker-icon {
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-family: 'Inter', sans-serif;
            color: #02a69b;
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Global Header -->
    <div id="global-header"></div>

    <main class="flex flex-col md:flex-row" style="height: calc(100vh - 88px);">
        <div class="w-full md:w-1/3 lg:w-1/4 h-1/2 md:h-full flex flex-col bg-gray-50 border-r">
            <div class="p-4 border-b">
                <h2 class="text-2xl font-display font-bold">Upcoming Stops</h2>
            </div>
            <div id="event-list-container" class="flex-grow overflow-y-auto p-4">
                <div id="loader" class="text-center py-10">
                    <div class="loader inline-block"></div>
                    <p class="mt-4 text-gray-600">Finding our food truck...</p>
                </div>
                <div id="event-list" class="space-y-3"></div>
                <div id="no-events" class="hidden text-center p-6"><i
                        class="fas fa-calendar-times fa-2x text-yellow-500 mb-4"></i>
                    <h3 class="font-bold font-display text-xl">No Upcoming Events</h3>
                    <p class="text-gray-500 mt-1 text-sm">Please check back soon!</p>
                </div>
            </div>
        </div>

        <div class="w-full md:w-2/3 lg:w-3/4 h-1/2 md:h-full">
            <div id="map"></div>
        </div>
    </main>

    <!-- Global Components Script -->
    <script src="js/components.js"></script>
    <script>
        // Load the shared header, passing 'events.html' to highlight the link
        loadHeader('events.html', 'standard');
    </script>

    <!-- Page Specific Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const eventListEl = document.getElementById('event-list');
            const loaderEl = document.getElementById('loader');
            const noEventsEl = document.getElementById('no-events');

            // Note: Mobile menu handling is now done by `components.js` inside `loadHeader`

            let map;
            let markers = {};
            let allEvents = [];
            let countdownInterval;

            // 1. INITIALIZE
            function initializeApp() {
                initializeMap();
                fetchAndProcessEvents();
            }

            function initializeMap() {
                map = L.map('map', { zoomControl: false }).setView([40.4406, -79.9959], 10);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(map);
            }

            // 2. DATA FETCHING & PROCESSING
            async function fetchAndProcessEvents() {
                const calendarId = atob('cGl0YW15c2hhd2FybWEuY29tX3JlNGo4cWJkdW9ldnZlY2Z2MGZpNDI2djRnQGdyb3VwLmNhbGVuZGFyLmdvb2dsZS5jb20');
                const icalUrl = `https://calendar.google.com/calendar/ical/${encodeURIComponent(calendarId)}/public/basic.ics`;
                const proxyUrl = `https://cors.eu.org/${icalUrl}`;

                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) throw new Error('Network response failed.');
                    const icalData = await response.text();
                    const parsedEvents = parseICal(icalData);
                    if (parsedEvents.length > 0) {
                        allEvents = await geocodeEvents(parsedEvents);
                        renderEventList(allEvents);
                        renderMapMarkers(allEvents);

                        // Start the countdown timer
                        updateCountdowns();
                        if (countdownInterval) clearInterval(countdownInterval); // Clear any existing interval
                        countdownInterval = setInterval(updateCountdowns, 10000); // Update every 10 seconds
                    } else {
                        displayNoEvents();
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    loaderEl.innerHTML = `<p class="text-red-500 p-4">Could not load events. Please try again later.</p>`;
                }
            }

            function parseICal(icalData) {
                const jcalData = ICAL.parse(icalData);
                const vcalendar = new ICAL.Component(jcalData);
                return vcalendar.getAllSubcomponents('vevent').map(vevent => {
                    const event = new ICAL.Event(vevent);
                    if (event.endDate.toJSDate() >= new Date()) {
                        return {
                            uid: event.uid,
                            summary: event.summary,
                            location: event.location,
                            startDate: event.startDate.toJSDate(),
                            endDate: event.endDate.toJSDate()
                        };
                    }
                    return null;
                }).filter(Boolean).sort((a, b) => a.startDate - b.startDate);
            }

            async function geocodeEvents(events) {
                const promises = events.map(async (event) => {
                    if (!event.location) return event;
                    try {
                        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(event.location)}&limit=1`;
                        const proxyUrl = `https://cors.eu.org/${nominatimUrl}`;
                        const response = await fetch(proxyUrl);
                        if (!response.ok) {
                            console.error(`Geocoding fetch failed for "${event.location}" with status: ${response.status}`);
                            return event;
                        }
                        const data = await response.json();
                        if (data && data.length > 0) {
                            event.lat = parseFloat(data[0].lat);
                            event.lon = parseFloat(data[0].lon);
                        }
                    } catch (e) { console.error("Geocoding error:", e); }
                    return event;
                });
                return Promise.all(promises);
            }

            // 3. UI RENDERING
            function renderEventList(events) {
                loaderEl.style.display = 'none';
                eventListEl.innerHTML = '';
                if (events.length === 0) {
                    displayNoEvents();
                    return;
                }
                noEventsEl.classList.add('hidden');
                events.forEach((event, index) => {
                    const card = document.createElement('div');
                    card.id = `event-${event.uid}`;
                    card.className = 'event-card bg-gray-100 p-3 rounded-lg cursor-pointer';
                    const directionsUrl = event.location ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.location)}` : '#';

                    card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <p class="font-semibold brand-teal text-sm">${formatEventDate(event.startDate)}</p>
                        <div class="flex space-x-3 text-gray-500 text-base">
                            <a href="${directionsUrl}" target="_blank" class="hover:text-brand-teal" title="Get Directions"><i class="fas fa-diamond-turn-right"></i></a>
                            <a href="${generateCalendarLink('google', event)}" target="_blank" class="hover:text-brand-teal" title="Add to Google Calendar"><i class="fab fa-google"></i></a>
                            <a href="${generateCalendarLink('ics', event)}" class="hover:text-brand-teal" title="Add to Apple/Outlook Calendar"><i class="fab fa-apple"></i></a>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg mt-1"><span class="brand-teal mr-2">${index + 1}.</span>${event.summary}</h3>
                    <p class="text-gray-600 text-sm mt-1"><i class="far fa-clock fa-fw mr-1"></i>${formatEventTime(event.startDate, event.endDate)}</p>
                    ${event.location ? `<p class="text-gray-600 text-sm mt-1"><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${event.location}</p>` : ''}
                    <p class="text-sm font-medium text-gray-500 mt-2" id="countdown-${event.uid}"></p>
                `;
                    eventListEl.appendChild(card);

                    card.addEventListener('click', () => {
                        if (event.lat && event.lon) {
                            map.flyTo([event.lat, event.lon], 15);
                            markers[event.uid]?.openPopup();
                        }
                        document.querySelectorAll('.event-card').forEach(c => c.classList.remove('active'));
                        card.classList.add('active');
                    });

                    const marker = markers[event.uid];
                    if (marker) {
                        card.addEventListener('mouseenter', () => marker.setZIndexOffset(1000));
                        card.addEventListener('mouseleave', () => marker.setZIndexOffset(0));
                    }
                });
            }

            function renderMapMarkers(events) {
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                markers = {};
                const bounds = [];

                events.forEach((event, index) => {
                    if (event.lat && event.lon) {
                        const foodTruckIcon = L.divIcon({
                            html: `<span class="text-lg">${index + 1}</span>`,
                            className: 'map-marker-icon',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });

                        const marker = L.marker([event.lat, event.lon], { icon: foodTruckIcon }).addTo(map);
                        marker.bindPopup(`<h3 class="font-bold font-display text-lg">${event.summary}</h3><p>${event.location}</p><a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(event.location)}" target="_blank" class="font-semibold brand-teal hover:underline">Get Directions</a>`);
                        marker.on('click', () => {
                            const card = document.getElementById(`event-${event.uid}`);
                            document.querySelectorAll('.event-card').forEach(c => c.classList.remove('active'));
                            card?.classList.add('active');
                            card?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });
                        markers[event.uid] = marker;
                        bounds.push([event.lat, event.lon]);
                    }
                });

                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
                }
            }

            function displayNoEvents() {
                loaderEl.style.display = 'none';
                noEventsEl.classList.remove('hidden');
            }

            // 4. COUNTDOWN
            function updateCountdowns() {
                const now = new Date();
                allEvents.forEach(event => {
                    const countdownEl = document.getElementById(`countdown-${event.uid}`);
                    if (!countdownEl) return;

                    const timeRemaining = event.startDate - now;

                    if (timeRemaining > 0) {
                        const { days, hours, minutes } = formatTimeRemaining(timeRemaining);
                        countdownEl.innerHTML = `(Starts in ${days}d ${hours}h ${minutes}m)`;
                        countdownEl.className = 'text-sm font-medium text-gray-500 mt-2';
                    } else if (now < event.endDate) {
                        countdownEl.innerHTML = `(Event is happening now!)`;
                        countdownEl.className = 'text-sm font-bold text-green-600 mt-2';
                    } else {
                        countdownEl.innerHTML = `(Event has ended)`;
                        countdownEl.className = 'text-sm font-medium text-red-500 mt-2';
                    }
                });
            }

            function formatTimeRemaining(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const totalMinutes = Math.floor(totalSeconds / 60);
                const totalHours = Math.floor(totalMinutes / 60);

                const days = Math.floor(totalHours / 24);
                const hours = totalHours % 24;
                const minutes = totalMinutes % 60;

                return { days, hours, minutes };
            }

            // 5. UTILITIES
            function formatEventDate(date) { return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); }
            function formatEventTime(start, end) { const opt = { hour: 'numeric', minute: '2-digit', hour12: true }; return `${start.toLocaleTimeString('en-US', opt).replace(' ', '')} - ${end.toLocaleTimeString('en-US', opt).replace(' ', '')}`; }

            function generateCalendarLink(type, event) {
                const formatTime = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');
                const startTime = formatTime(event.startDate);
                const endTime = formatTime(event.endDate);

                if (type === 'google') {
                    const url = new URL('https://calendar.google.com/calendar/render');
                    url.searchParams.set('action', 'TEMPLATE');
                    url.searchParams.set('text', event.summary);
                    url.searchParams.set('dates', `${startTime}/${endTime}`);
                    url.searchParams.set('location', event.location || '');
                    return url.toString();
                }
                if (type === 'ics') {
                    const icsData = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'BEGIN:VEVENT', `UID:${event.uid}`, `DTSTAMP:${formatTime(new Date())}`, `DTSTART:${startTime}`, `DTEND:${endTime}`, `SUMMARY:${event.summary}`, `LOCATION:${event.location || ''}`, 'END:VEVENT', 'END:VCALENDAR'].join('\n');
                    return `data:text/calendar;charset=utf8,${encodeURIComponent(icsData)}`;
                }
            }

            // START THE APP
            initializeApp();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
</body>

</html>